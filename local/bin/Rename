#!/bin/bash

print_info()
{
	echo "${C_GREEN}$1${C_END} $2"
}

usage()#{{{
{
	cat << USAGE_END
$1 : ÌäπÏ†ï ÌååÏùºÎ™Ö ÎòêÎäî ÌååÏùºÎÇ¥Ïùò Ïä§Ìä∏ÎßÅÏùÑ ÌäπÏ†ï Ìå®ÌÑ¥ÏóêÏÑú ÌäπÏ†ï ÌÉÄÍ≤üÏúºÎ°ú Î≥ÄÍ≤ΩÌïúÎã§.
Ìå®ÌÑ¥ÏóêÎäî sedÏóêÏÑú ÏßÄÏõêÌïòÎäî (ÎπÑÌôïÏû•) Ï†ïÍ∑úÌëúÌòÑÏãùÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎã§.

Usage: $1 [c/d/r/s] -p sed_pattern -t sed_taret

-c : ANSI Ïª¨Îü¨ ÏÇ¨Ïö©
-r : ÌïòÏúÑ ÎîîÎ†âÌÜ†Î¶¨ÎèÑ ÌÉêÏÉâÌïúÎã§.
-d : ÎîîÎ†âÌÜ†Î¶¨ÎèÑ Ïù¥Î¶Ñ Î≥ÄÍ≤ΩÌïúÎã§.
-s : ÌååÏùºÎÇ¥Ïùò Ïä§Ìä∏ÎßÅÏùÑ Î≥ÄÍ≤ΩÌïúÎã§. (Í∏∞Î≥∏Í∞í, ÌååÏùºÎ™Ö Î≥ÄÍ≤Ω)
	
USAGE_END
}
#}}}

rename_matched_file()#{{{
{
	local files=`ls --width=1`
	local tab=$1

	for old in $files
	do
		# ÌååÏùºÏù∏Í≤ΩÏö∞, ÌòπÏùÄ ÎîîÎ†âÌÜ†Î¶¨ Î≥ÄÍ≤Ω ÏòµÏÖòÏùÑ Ïº∞ÏùÑÎïå ÎîîÎ†âÌÜ†Î¶¨ÎèÑ
		if [[ -f "$old" ]] || [[ -d "$old" && -n "$DIR_RENAME" ]] 
		then
			local new=`echo $old | sed -e "s/$PT/$TG/g"`

			if [ "$old" != "$new" ]
			then
				print_info "${tab}mv" "'$old' '$new'"
				mv $old $new
				old=$new
			fi
		fi

		# Ïû¨Í∑ÄÏòµÏÖòÏùÑ Ïº∞ÏùÑÎïå
		if [ -n "$RECURSIVE" ] && [ -d "$old" ]
		then
			print_info "${tab}cd" "$old"
			cd $old
			rename_matched_file "${tab}	"
			print_info "${tab}cd" ".."
			cd ..
		fi
	done
}
#}}}

change_string()#{{{
{
	local files=`ls --width=1`
	local tab=$1

	for f in $files
	do
		# ÌååÏùºÏù∏ Í≤ΩÏö∞
		if [[ -f "$f" ]]
		then
			local ret_cat=`cat $f | sed -e "s@$PT@$TG@g"`
		
			print_info "${tab}change string" " $f"
			{
				cat << CAT_END
$ret_cat
CAT_END
			} > $f

		# Ïû¨Í∑ÄÏòµÏÖòÏùÑ Ïº† Í≤ΩÏö∞
		elif [[ -n "$RECURSIVE" && -d "$f" ]]
		then
			print_info "${tab}cd" "$f"
			cd $f
			change_string "${tab}	"
			print_info "${tab}cd" ".."
			cd ..
		fi
	done
}
#}}}

### MAIN ####

while getopts ":crdp:t:s" Option
do
  case $Option in
	c     ) 
			C_GREEN='[32m'
			C_END='[0m'
			;;
	d     ) DIR_RENAME=1;;
	r     ) RECURSIVE=1;;
	s     ) CHANGE_STRING=1;;
	p     ) PT=$OPTARG;;
	t     ) TG=$OPTARG;;
	*     ) usage $0
			exit 1;;
  esac
done

if [[ -z $PT || -z $TG ]]
then
	usage $0
	exit 1
fi

if [ -n "$CHANGE_STRING" ]
then
	change_string
else
	rename_matched_file
fi

# vim: enc=utf8 fdm=marker cms=#%s
