#!/bin/bash

CMD=`basename $0`
ORG_DIR=
NEW_DIR=./
LIST_ONLY=

usage()#{{{
{
	cat << USAGE_END
$1 : 구조가 같은 두 디렉토리 하위의 파일 내용을 비교한다.
파일의 내용이 다른 경우에 한해서 vimdiff로 열어준다.
(기준이 되는 파일 목록은 NEW_PATH에서 추출한다.)

Usage: $1 -o ORG_PATH -n NEW_PATH

-o : 원본 경로 (필수)
-n : 비교할 새 경로 (기본값: ./)
-l : vimdiff 없이, 목록만 출력
	
USAGE_END
}
#}}}

### MAIN ####

while getopts "o:n:l" Option
do
  case $Option in
	o     ) ORG_DIR=$OPTARG;;
	n     ) NEW_DIR=$OPTARG;;
	l     ) LIST_ONLY=1;;
	*     ) usage $CMD
			exit 1;;
  esac
done

if [ -z "$ORG_DIR" ]
then
	usage $CMD
	exit 1
fi

ORG_DIR=`dirname $ORG_DIR`/`basename $ORG_DIR`
NEW_DIR=`dirname $NEW_DIR`/`basename $NEW_DIR`
FIND_CMD=`find $NEW_DIR ! \( \( -path '*.svn' -o -path '*.libs' -o -path '*.depend' \) -prune \) ! \( -type d \) -print`

for target_file in $FIND_CMD
do 
	org_file=`echo $target_file | sed -e "s|${NEW_DIR}|${ORG_DIR}|"`

	if [ -n "`diff $org_file $target_file`" ]
	then
		if [ -n "$LIST_ONLY" ]
		then
			echo $target_file
		else
			vimdiff $org_file $target_file
		fi
	fi
done

# vim: enc=utf8 fdm=marker cms=#%s
